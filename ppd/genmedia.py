from io import TextIOWrapper
from typing import Sequence
import sys
import os

DEFAULT = "A4"
GENERATE_BORDERLESS = True

SIZE_DOT_W_VAR = "cupsInteger0"
SIZE_DOT_H_VAR = "cupsInteger1"
PAPER_SIZE_ID_VAR = "cupsInteger2"

# left bottom right top
MARGINS_MM = (2, 3.556, 2, 3.556)

PAGE_SIZE_TABLE = {
    0x01: ("Letter", 0x0d, 612, 792, 5100, 6600),
    0x03: ("Ledger", 0x0b, 792, 1224, 6600, 10200),
    0x05: ("Legal", 0x0c, 612, 1008, 5100, 8400),
    0x07: ("Executive", 0x0a, 522, 756, 4350, 6300),
    0x08: ("A3", 0x01, 842, 1191, 7014, 9920),
    0x09: ("A4", 0x02, 595, 842, 4960, 7014),
    0x0b: ("A5", 0x03, 420, 595, 3506, 4960),
    0x0c: ("B4", 0x06, 729, 1032, 6070, 8598),
    0x0d: ("B5", 0x07, 516, 729, 4298, 6070),
    0x14: ("Env10", 0x16, 297, 684, 2480, 5692),
    0x1b: ("EnvDL", 0x18, 312, 624, 2598, 5196),
    0x1c: ("EnvC5", 0x15, 459, 649, 3826, 5408),
    0x1f: ("jenv_you2", 0x1c, 323, 459, 2692, 3826),
    0x22: ("Envelope_B5", 0x19, 499, 709, 4134, 5906),
    0x25: ("EnvMonarch", 0x17, 279, 540, 2314, 4510),
    0x2b: ("Postcard", 0x0e, 283, 420, 2362, 3506),
    0x47: ("jenv_kaku2", 0x1b, 680, 941, 5669, 7842),
    0x52: ("DoublePostcardRotated", 0x0f, 420, 567, 3506, 4724),
    0x5b: ("jenv_you4", 0x1a, 296, 666, 2480, 5550),
    0x0106: ("Envelope_C6", 0x1c, 323, 459, 2692, 3826),
    0x10cc: ("4x_postcard", 0x37, 567, 842, 4724, 7014),
    0x11f8: ("3x5", 0, 216, 360, 1800, 3000),
}

IMAGE_SIZE_TABLE = {
    0x01: (4896, 6368),
    0x05: (4896, 8192),
    0x07: (4096, 6080),
    0x09: (4768, 6784),
    0x0b: (3296, 4736),
    0x0d: (4032, 5856),
    0x14: (2272, 5472),
    0x1b: (2400, 4960),
    0x1c: (3616, 5184),
    0x25: (2112, 4288),
    0x2b: (2144, 3296),
    0x52: (3296, 4512),
    0x5b: (2272, 5312),
    0x11f8: (1568, 2784),
}

def writeCustomMedia(fs: TextIOWrapper, name: str, id: int, sizePt: Sequence, margins: Sequence, sizeDot: Sequence, default: bool) -> None:
    if default:
        fs.write("*")
    fs.write(f"CustomMedia {name} {str.join(' ', map(str, sizePt))} {str.join(' ', map(str, margins))}\n")
    for _ in range(0, 2):
        fs.write(f'    "<</PageSize[{str.join(" ", map(str, sizePt))}]/ImagingBBox null/{SIZE_DOT_W_VAR} {sizeDot[0]}/{SIZE_DOT_H_VAR} {sizeDot[1]}/{PAPER_SIZE_ID_VAR} {id}>>setpagedevice"\n')

def main() -> int:
    if len(sys.argv) != 2:
        print(f"Usage: {sys.argv[0]} outfile")
        return 1
    with open(sys.argv[1], mode="w", encoding="utf8") as fs:
        fs.write("/*\n")
        fs.write(f" * NOTE: This file is auto-generated by {os.path.basename(__file__)}\n")
        fs.write(" */\n\n")
        count = 0
        for pageSizeId in sorted(IMAGE_SIZE_TABLE.keys()):
            margins = [str(i) + ("mm" if i != 0 else "") for i in MARGINS_MM]
            name = PAGE_SIZE_TABLE[pageSizeId][0]
            sizePt = PAGE_SIZE_TABLE[pageSizeId][2:4]
            paperSizeId = PAGE_SIZE_TABLE[pageSizeId][1]
            sizeDot = PAGE_SIZE_TABLE[pageSizeId][4:6]
            fs.write(f"// {name}: PageSize={pageSizeId} PaperSize={paperSizeId} paperSizePx={sizeDot}\n")
            writeCustomMedia(fs, name, paperSizeId, sizePt, margins, sizeDot, name == DEFAULT)
            if GENERATE_BORDERLESS:
                writeCustomMedia(fs, f'"{name}.Borderless/{name} (borderless)"', paperSizeId, sizePt, (0, 0, 0, 0), sizeDot, False)
            count += 1
            if count != len(IMAGE_SIZE_TABLE):
                fs.write("\n")
    return 0

if __name__ == "__main__":
    sys.exit(main())
